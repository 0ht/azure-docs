---
title: SignalR Application Firewall (Preview)
description: An introduction about why and how to setup Application Firewall for Azure SignalR service
author: biqian
ms.service: signalr
ms.custom: devx-track-azurecli
ms.topic: how-to
ms.date: 07/10/2024
ms.author: biqian
---
# Application Firewall for Azure SignalR Service

Application Firewall brings more sophisticated control over client connections over a distributed system. In this doc,  typical scenarios are  demonstrated to show how Application Firewall rules work and how to configure them. Before that, let's clarify what Application Firewall don't do:

1. It's not intended to replace Authentication. The firewall works behind the client conenction authentication layer.
2. It's not related to the network layer access control. 

What does the application firewall do? The application firewall contains rule list of different categories. For now, there is a rule list called Client Connection Count Rules. More rule list will be supported in the future to control things like connection lifetime, connection message sending throughput.

THis guidline is divided into three parts. 
1. Introduce different application firewall rules
2. Show how to configure the rules using Portal or Bicep at SignalR service side
3. Describe how to configure the token at server side

## Prerequisites

* An Azure SignalR Service in [Premium tier](https://azure.microsoft.com/pricing/details/signalr-service/).

## Client Connection Count Rules
Client Connection Count Rules pose restriction on the concurrent client connections. When the client tries to establish new connection, rules will be checked sequencially. If any of the rules is violated, the connection will be rejected with status code 429. 

### Rule introduction

   #### ThrottleByUserIdRule
   Some users of Contoso might keep requesting tokens to establish connections. For example, one user might open tens of browser tabs or login using different devices, you can use the ThrottleByUserIdRule to limit the concurrent connection of a user.
   #### ThrottleByJwtSignatureRule
   Some malicious user might reuse the token to establish infinite connections. This brings risk of exhausting connection quota. You can use the ThrottleByJwtSignatureRule to limit the concurrent connection of the same token.
   > [!NOTE]
   > Each token generated by SDK contains a timestamp. If vast tokens are generated within seconds, the token might be identical. To avoid this, a random claim could be inserted into the token claim.
   #### ThrottleByJwtCustomClaimRule
   More advancedly, Contoso offers its service to different groups or companies. Contoso wants to put limit of the connections each group/company can have at the same time. 
   You could use the ThrottleByJwtCustomClaimRule to put different limits on different groups or companies.

 ### Best Practice
  #### Avoid using too aggressive limit

  SignalR service would aggregate the client connections according to the rules. Since the TCP connection might disconnect without completing the 4-way handshake, SignalR service would still count those "orphan" connections until they are disconnected because the heartbeat failure. So, a very aggresive throttling strategy might throttle the clients unexpectly. A smoother way is doubling the maxCount.




## Setup Application Firewall 

# [Portal](#tab/Portal)
To use Application Firewall, Navigate to the SignalR **Application Firewall** blade on the Azure portal and click **Add** to add a rule. 

![Screenshot of creating replica for Azure SignalR on Portal.](./media/howto-enable-geo-replication/signalr-replica-create.png "Replica create")

# [Bicep](#tab/Bicep)

Use Visual Studio Code or your favorite editor to create a file with the following content and name it main.bicep:

```bicep
@description('The name for your SignalR service')
param resourceName string = 'contoso'

resource signalr 'Microsoft.SignalRService/signalr@2024-04-01-preview' = {
  name: resourceName
  properties: {
    applicationFirewall:{
        clientConnectionCountRules:[
            // Add or remove rules as needed
            {
                type: 'ThrottleByUserIdRule'
                maxCount: 5
            }
            {
                type: 'ThrottleByJwtSignatureRule'
                maxCount: 10
            }
            {
                type: 'ThrottleByJwtCustomClaimRule'
                maxCount: 10
                customClaim: 'customClaimA'
            }
            {
                type: 'ThrottleByJwtCustomClaimRule'  
                maxCount: 10
                customClaim: 'customClaimB'
          }
        ]
    }
  }
}

```

Deploy the Bicep file using Azure CLI 
   ```azurecli
   az deployment group create --resource-group MyResourceGroup --template-file main.bicep
   ```

----



## Set UserId or Custom claim at server side
To enforce the limit of concurrent client connections, what Azure SignaLR service does is aggragating different client connections. The aggragated key is extracted from the JWTToken which is generated by the app server. Thus, to make the client connections rules work, necessary claims need to exist.

https://learn.microsoft.com/en-us/azure/azure-signalr/signalr-concept-client-negotiation#custom-settings-for-client-connections
To ensure the uniqunice of the claim signature, you could insert a unique claim for example a guid.





