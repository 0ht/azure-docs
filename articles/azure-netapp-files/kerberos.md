---
title: Understand Kerberos in Azure NetApp Files 
description: Learn how Kerberos works in Azure NetApp Files. 
services: azure-netapp-files
author: whyistheinternetbroken
ms.service: azure-netapp-files
ms.topic: conceptual
ms.date: 01/02/2025
ms.author: anfdocs
---

# Understand Kerberos in Azure NetApp Files

Kerberos is an authentication protocol that uses a secret key to validate the identity of principals. Secret keys are generated by taking a principal's password and converting it into a hashed cryptographic key format using an agreed upon encryption method by the client and server (such as AES). See the [Kerberos terminology](#kerberos-terminology) section to learn about the terms used in this document.

Key Distribution Centers (KDCs) such as Windows Active Directory maintain a database of Kerberos principals and their hashed passwords. In Kerberos, the secret key is proof of a unique identity. Therefore, the KDC can be trusted to authenticate any principal to any other principal such as authenticating an NFS client Service Principal Name (SPN) to an NFS server SPN at mount. It can also be trusted to authenticate a user principal to an NFS server SPN for user access to a NAS mount point. As an added security measure, Kerberos doesn't send cleartext passwords for authentication across the wire.

Azure NetApp Files supports the use of Kerberos to provide in-flight security for both the SMB and NFS protocols.


## Supported encryption types

Azure NetApp Files supports NFS Kerberos with specific encryption types, depending on the operating mode and the version that you use.

To ensure that a client uses the appropriate encryption type, you can limit the valid encryption types on the object principal located on the KDC (for example, the machine account) or in the client’s manual created keytab file rather than globally in the /etc/krb5.conf file, if possible, since management of numerous client krb5.conf files can be a management headache. Centrally managing Kerberos from the KDC is more scalable in large enterprise environments, is easier to automate, and forces the client to use stronger encryption types when they are supported.

>[!NOTE]
>It's recommended to set the option `allow_weak_crypto` to false in the krb5.conf file on clients. This setting prevents less secure `enctypes` for Kerberos communication (such as DES or 3DES).

The following table shows the supported encryption types for Kerberos (both SMB and NFS) for Azure NetApp Files.

| Protocol | Supported encryption types |
| --- | --- |
| SMB | <ul><li>RC4-HMAC</li><li>AES-128</li><li>AES-256</li></ul> |
| NFS | AES-256 |

### Supported NFS Kerberos security modes

In addition to the concept of encryption types, there are also levels of security and integrity checking in Kerberos. Depending on the security mode in use, these security modes help prevent man-in-the-middle attacks by offering end-to-end encryption for NFS traffic. 

In Azure NetApp Files, these security modes are specified on the export policy rules set for the volume for NFS and defined during the initial NFS mount via the sec mount option. 

For instance: `# mount -o sec=krb5p`

>[!NOTE]
> For SMB Kerberos, security modes for Kerberos are controlled via [SMB encryption](understand-data-encryption.md) settings on the share, [UNC hardening](understand-data-encryption.md#unc-hardening), and [SMB signing/sealing policies](azure-netapp-files-smb-performance.md#smb-signing) on the domain controllers.

The following security modes are supported by Azure NetApp Files for use with NFS Kerberos:

| Security mode	| Description |
| -- | ------ |
| krb5	| _Authentication encryption only._ <br></br> Uses Kerberos V5 name strings and user principal names instead of local UNIX user IDs (UIDs) and group IDs (GIDs) to authenticate users. |
| krb5i | _Authentication encryption and encrypted integrity checking._ <br></br> Uses Kerberos V5 for user authentication and also performs integrity checking of NFS operations by using secure checksums to prevent data tampering and man-in-the-middle attacks. |
| krb5p | _Entire NFS conversation encrypted._ <br></br> Uses Kerberos V5 for user authentication and integrity checking and also encrypts all NFS traffic to prevent packet sniffing. This setting is the most secure, but it also creates the most performance overhead. |

## Kerberos terminology

This section defines key terminology that is used when describing Kerberos processes. This section is meant to help clarify terms that might be unfamiliar to storage administrators.

| Term | Definition |
| -- | ------ |
| Key distribution center (KDC)	| The KDC is the authentication server that includes the ticket-granting service (TGS) and the authentication service (AS). The terms KDC, AS, and TGS are used interchangeably. In Microsoft environments, an Active Directory domain controller is a KDC. |
| Realm (or Kerberos realm) | A realm (or Kerberos realm) can use any ASCII string. The standard is to use the domain name in uppercase; for example, contoso.com becomes the realm CONTOSO.COM. Kerberos realms usually are configured in krb5.conf files on clients and servers. <br></br> Administratively, each principal@REALM must be unique.To avoid a single point of failure, each realm can have multiple KDCs that share the same database (principals and their passwords) and have the same KDC master keys. Microsoft Windows Active Directory does this natively by way of Active Directory replication, which takes place every 15 minutes by default.
| Principal	| The term principal refers to every entity within a Kerberos database. Users, computers, and services are all assigned principals for Kerberos authentication. Every principal must be unique within the Kerberos database and is defined by its distinguished name. A principal can be a user principal name (UPN) or a service principal name (SPN). <br></br> A principal name has three parts: <ul><li>**Primary** - The primary part can be a user or a service such as the “nfs” service. It can also be the special service “host,” which signifies that this service principal is set up to provide multiple various network services.</li><li>**Instance** - This part is optional in the case of a user. A user can have more than one principal, but each principal must be unique in the KDC. For example, Fred might have a principal that is for everyday use (fred@contoso.com) and a principal that allows privileged use such as a sysadmin account (admin-fred@contoso.com). The instance is required for service principals and designates the fully qualified domain name (FQDN) of the host that provides the service.</li><li>**Realm** - A Kerberos realm is the set of Kerberos principals that are registered within a Kerberos server. By convention, the realm name is usually the same as the DNS name, but it is converted to uppercase letters. Uppercase letters are not obligatory, but the convention provides easy distinction between the DNS name and the realm name.</li></ul> <!-- image --> |
| Tickets | A ticket is a temporary set of credentials that verifies the identity of a principal for a service and contains the session key. A ticket can be a service, an application ticket, or a ticket-granting ticket (TGT). Tickets are exchanged between client, server and KDC for Kerberos authentication. |
| Secret keys | Kerberos uses a symmetric key system in which the secret key is used for both encryption and decryption. The secret key is generated from the principal’s Kerberos password with a one-way hash function. The KDC stores the password for each principal and can thus generate the principal’s secret key. For users who request a Kerberos service, the secret key is typically derived from a password presented to the kinit program. Service and daemon principals typically don’t use a password; instead, the result of the one-way hash function is stored in a keytab. |
| Keytab | A keytab contains a list of principals and their secret keys. The secret keys in a keytab are often created by using a random password and are used mostly for service or daemon principals. |

## Network port information

The following table covers which network ports are used for Kerberos communications. If a network firewall is in place, these ports should be opened to allow proper Kerberos functionality. You can find more information about these ports at the [IANA Service Name and Transport Protocol Port Number Registry](https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml?search=kerberos).

| Service | Port | 
| - | - |
| Kerberos | 88 (TCP/UDP) |
| kpasswd | 464 (TCP/UDP) |
| Lightweight directory access protocol (LDAP) (for name mappings) | 389 (TCP/UDP) |
| Admin server | 749 (TCP/UDP) |
| Global catalog (Windows user lookups)	| 3268 (TCP/UDP) |

## Cache age values in Azure NetApp Files

The following table displays the amount of time a cache entry lives in an Azure NetApp Files volume.

| Cache | Cache age |
| --- | --- | 
| Idle name server connections | 60 seconds |
| LDAP query timeout | 10 seconds |
| Local DNS host entry for KDC TTL | 24 hours |
| Kerberos ticket age | Specified by KDC* and/or client <br></br> *[Defaults to 10 hours](/windows/it-pro/windows-10/security/threat-protection/security-policy-settings/maximum-lifetime-for-user-ticket#default-values) for Windows Active Directory KDCs |
| User credentials | 24 hours |
| Kerberos time skew | 5 minutes |

## Requirements for properly functioning Kerberos environments in Azure NetApp Files

Kerberos authentication is highly dependent on external services for proper functionality. In Microsoft Active Directory, most of those services are combined into a single server in many cases. For instance, an Active Directory domain controller can service the following Kerberos dependencies:

- Time synchronization services
- DNS
- Kerberos key distribution
- Password services/single sign on
- Identity services (such as LDAP)
- 
When using native Microsoft Active Directory (the only KDC type that Azure NetApp Files currently supports), then most of the external dependencies for Kerberos in Azure NetApp Files are covered, such as DNS, KDC, and password services. In some cases, required services may be hosted outside of the Active Directory domain (such as DNS). In those cases, it's important to ensure the required services are configured properly. 

Azure NetApp Files has specific dependencies for properly functioning NFS Kerberos. Continue reading for more information. 

### Time synchronization services

Time synchronization services are mandatory when using Kerberos for authentication, as the Kerberos ticket mechanisms depend on time skews between client and server being within a default 5-minute range. If the time settings on client or server exceed that five-minute range, Kerberos authentication fails with a time skew error (KRB_AP_ERR_SKEW) and access is denied to the NAS share. This timeout is a security feature that helps prevent "replay attacks," where an attacker can intercept messages between the KDC and client and then replay those messages at a later time to impersonate an authenticated user. Time skew limits help minimize the risk of those types of attacks.

Key considerations for time sync issues:

- External time servers (such as those found in NIST) [should be configured for use with Active Directory domains](/services-hub/unified/health/remediation-steps-ad/configure-the-root-pdc-with-an-authoritative-time-source-and-avoid-widespread-time-skew) to provide accurate, consistent time services.
- [Time skew errors can be seen in the event viewer](/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4768) on the KDC with the error KRB_AP_ERR_SKEW, as well as in packet captures.
- [Replay attack attempts get logged](/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4649) in the event viewer with KRB_AP_ERR_REPEAT.

For more information, see [Maximum tolerance for computer clock synchronization](/windows/it-pro/windows-10/security/threat-protection/security-policy-settings/maximum-tolerance-for-computer-clock-synchronization)

### Domain Name Systems (DNS)

Domain Name Systems (DNS) are mandatory for Kerberos as a security feature. Hostname resolution is used to formulate the Kerberos service principals used for authentication. In this process, forward lookups for hostnames (A/AAAA records) are used to connect to shares that leverage Kerberos authentication. That forward lookup is then used to formulate the Service Principal Name (SPN) used in the Kerberos authentication request. If an existing SPN cannot be found in the KDC, then Kerberos authentication will fail. 

In Windows SMB environments, a backup authentication method may be tried (such as NTLM). However, in many cases, NTLM is disabled for security reasons, which would cause an access failure to the share when Kerberos authentication fails. The Windows event viewer will often log the root cause of the failures (such as duplicate/missing SPNs, DNS lookup failures, NTLM failures, etc).

In addition to SPN resolution, DNS is heavily utilized to resolve hostnames and IP addresses for domain services, such as LDAP, Kerberos KDCs, etc. via SRV records. For more detailed information on DNS in Azure NetApp Files (including what SRV records are required), see [About DNS in Azure NetApp Files](domain-name-system-concept.md).

>[!NOTE]
>If an IP address is used for Kerberos access, the behavior depends on the NAS protocol (NFS or SMB) in use. See [IP addresses for access with Kerberos](LINK) for more information.

### Lightweight directory access protocol 

The [Lightweight Directory Access Protocol (LDAP)](/previous-versions/windows/desktop/ldap/lightweight-directory-access-protocol-ldap-api) leverages backend identity databases to provide a unified name service source for NAS clients and servers so that all participating devices agree on user authenticity, group memberships and numeric IDs, which are then used for file permissions.

For Kerberos, user and service principals are stored with the entries in the LDAP databases as attributes on the principal accounts. Windows Active Directory supports this by default. In some cases (such as when creating aliases or service principals), users and computers require the addition or modification of service principal names. You can satisfy this requirement using the Active Directory Users and Computers Microsoft Management Console (MMC) or with PowerShell. For more information on managing service principal names, see [Managing service principal names](LINK).

In addition to service principal names and numeric IDs for Kerberos authentication, LDAP can also be used for UNIX user and group identities, which are used for name mapping of identities in Azure NetApp Files, as well as initial authentication for NFS Kerberos mounts via an SPN -> UNIX user name mapping. For more details, see [How NFS Kerberos works in Azure NetApp Files](LINK) and [LDAP’s role with Kerberos in Azure NetApp Files](LINK).

## How SMB Kerberos works in Azure NetApp Files

SMB Kerberos works separately from NFS Kerberos services, as the machine accounts created for each protocol cannot share keytabs because of the potential for changes to the Key Version Number ([kvno](https://web.mit.edu/kerberos/krb5-latest/doc/user/user_commands/kvno.html)) in one keytab impacting the other service. As a result of this, as well as natural differences in the NAS protocols, the workflows for SMB services for Kerberos and NFS for Kerberos will differ in functionality in some areas.

### Initial configuration of SMB services

SMB services in Azure NetApp Files are initially configured by setting up an Active Directory connection, which defines several critical pieces for interaction with domain services, including:

- Primary DNS server (required)
- Secondary DNS
- Active Directory DNS name*
- Active Directory site name (for DC discovery) (required)
- SMB server prefix name
- Organizational unit (where machine accounts should be stored in the AD domain)
- AES encryption enable/disable
- LDAP signing enable/disable
- LDAP configuration
- SMB encryption to DC
- Privileged users
- Username/password credentials of user with OU permissions

<!-- AD IMAGE -->

>[!NOTE]
>Only one AD connection is allowed per account. Once the AD connection is created, any new Azure NetApp Files SMB volume uses the AD connection configuration.

### SMB Kerberos machine account

A machine account in Active Directory contains relevant information for use in authentication requests, including the Service Principal Name (SPN). When you create an SMB volume in Azure NetApp Files, the Active Directory connections configuration is used for interaction in creating a machine account to provide secure access to an SMB share via Kerberos (or NTLM, if enabled) authentication.

New machine accounts are created when an Azure NetApp Files SMB volume is provisioned on a specific backend resource in the service. The following shows different scenarios where an SMB machine account might be created or reused in Azure NetApp Files volume configurations.

| Scenario | Result |
| --- | -------- |
| First new SMB volume | New SMB machine account/DNS name |
| Subsequent SMB volumes created in short succession from first SMB volume | Reused SMB machine account/DNS name (in most cases). |
| Subsequent SMB volumes created much later than first SMB volume | Service determines if new machine account will be needed, but it is a possibility that multiple machine accounts can be created, which will create multiple IP address endpoints. |
| First dual protocol volume | New SMB machine account/DNS name |
| Subsequent dual protocol volumes created in short succession from first dual protocol volume	| Re-used SMB machine account/DNS name (in most cases) |
| Subsequent dual protocol volumes created much later than first dual protocol volume | Service determines if new machine account will be needed, but it is a possibility that multiple machine accounts can be created, which will create multiple IP address endpoints |
| First SMB volume created after dual protocol volume | New SMB machine account/DNS name |
| First dual protocol volume created after SMB volume | New SMB machine account/DNS name |

The SMB machine account created for the Azure NetApp Files SMB (or dual protocol) volume uses a naming convention that adheres to the [15-character maximum that is enforced by Active Directory](/troubleshoot/windows-server/active-directory/naming-conventions-for-computer-domain-site-ou). The name uses the structure of [SMB Server prefix specified in AD connection configuration]-[unique numeric identifier].

For instance, if you've [configured your AD connections](create-active-directory-connections.md) to use the SMB server prefix "AZURE," the SMB machine account that Azure NetApp Files creates resembles "AZURE-7806." That same name is used in the UNC path for the SMB share (for example, \\AZURE-7806) and is the name that dynamic DNS services use to create the A/AAAA record. 

>[!NOTE]
>Because a name like “AZURE-7806” can be hard to remember, it's beneficial to create a CNAME record as a DNS alias for Azure NetApp Files volumes. For more information, see [Creating SMB server aliases](LINK).

<!-- Multiple machine accounts/DNS entries in Azure NetApp Files image -->

In some cases, when creating multiple SMB and/or dual protocol volumes, the configuration can end up with multiple disparate SMB machine accounts and DNS names.

If a single namespace for user access across the volumes is desired, this can present a challenge in configuration, as a single CNAME alias can only point to a single A/AAAA host record, while using multiple identical A/AAAA record aliases can result in unpredictability of data access in accessing volumes across different SMB machine accounts, as there is no guarantee that the endpoint the client selects in the DNS lookup will contain the expected volume due to the round-robin nature of DNS record selection in those configurations. 

To address this limitation, [Azure NetApp Files volumes can participate as targets](use-dfs-n-and-dfs-root-consolidation-with-azure-netapp-files.md) in a [Microsoft Distributed File System (DFS)](/windows/win32/dfs/distributed-file-system-dfs-functions) configuration, which can provide a way to associate multiple SMB volumes with a single namespace entry point.

<!-- AD diagram -->

### SMB Kerberos SPN creation workflow

The following diagram illustrates how an SMB Kerberos SPN is created when an Azure NetApp Files SMB or dual protocol volume is created. SMB SPNs are associated with SMB machine account objects in the domain. The SPN can be viewed and managed via the machine account properties using the attribute editor in the Advanced view.

<!-- Azure SMB -->

You can also view and manage properties with the `setspn` command. 

It can also be viewed and managed using the setspn command.

<!-- setspn command -->

This process follows the same steps as when a regular Windows client joins a domain (DNS, LDAP, Kerberos, RPC queries over named pipes). 

<!-- diagram with a lot of bidirectional arrows -->

In most cases, knowing detailed steps in depth isn't be necessary for day-to-day administration tasks, but is useful in troubleshooting any failures when attempting to create an SMB volume in Azure NetApp Files.

#### Detailed steps

For detailed steps about how an SMB machine account is created in Azure NetApp Files, expand the list below.
<!-- collapsible -->

